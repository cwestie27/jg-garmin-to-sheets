name: Daily Garmin Sync

on:
  schedule:
    # Runs at 08:00 UTC every day. Adjust as needed.
    - cron: '0 8 * * *'
  workflow_dispatch: # Allows you to run it manually to test

jobs:
  sync_data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Sync Script
        env:
          # Load secrets into environment variables
          GARMIN_EMAIL: ${{ secrets.GARMIN_EMAIL }}
          GARMIN_PASSWORD: ${{ secrets.GARMIN_PASSWORD }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }} # Assuming this contains the JSON content
          GARMIN_TOKENS: ${{ secrets.GARMIN_TOKENS }}
        run: |
          # 1. Create the Google Credentials file (Fixing the "File not found" error)
          mkdir -p credentials
          echo "$GCP_CREDENTIALS" > credentials/client_secret.json

          # 2. Create the .env file with the specific names the script expects
          # Note: Script looks for USER1_EMAIL, not USER1_GARMIN_EMAIL
          echo "USER1_EMAIL=$GARMIN_EMAIL" >> .env
          echo "USER1_PASSWORD=$GARMIN_PASSWORD" >> .env
          echo "USER1_SHEET_ID=$SHEET_ID" >> .env
          
          # 3. Run the script with "Piped" input to bypass the menu
          # "2"      <- Select Google Sheets
          # "USER1"  <- Select the profile we just made
          # "N"      <- If it asks "Edit dates?", say No to use defaults
          printf "2\nUSER1\nN\n" | python -m src.main
