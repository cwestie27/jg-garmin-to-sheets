name: Daily Garmin Sync

on:
  schedule:
    # Runs at 08:00 UTC every day. Adjust as needed.
    - cron: '0 8 * * *'
  workflow_dispatch: # Allows you to run it manually to test

jobs:
  sync_data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Sync Script
        env:
          # We still load these to write them to the file below
          GARMIN_EMAIL: ${{ secrets.GARMIN_EMAIL }}
          GARMIN_PASSWORD: ${{ secrets.GARMIN_PASSWORD }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
          GARMIN_TOKENS: ${{ secrets.GARMIN_TOKENS }}
        run: |
          # 1. Create the Auth JSON file
          echo "$GCP_CREDENTIALS" > service_account.json

          # 2. Create the .env file (The script looks for this specifically)
          # We use "USER1_" because that is the default profile name in this script
          echo "USER1_GARMIN_EMAIL=$GARMIN_EMAIL" >> .env
          echo "USER1_GARMIN_PASSWORD=$GARMIN_PASSWORD" >> .env
          echo "USER1_SHEET_ID=$SHEET_ID" >> .env
          
          # 3. Run the script with "Piped" input to bypass the menu
          # The inputs being sent are:
          # "2"      <- Select Google Sheets
          # "USER1"  <- Select the profile we just made
          # "N"      <- (Guess) If it asks "Edit dates?", say No to use defaults
          printf "2\nUSER1\nN\n" | python -m src.main
